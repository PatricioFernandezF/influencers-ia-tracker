FROM node:22-alpine

RUN apk add --no-cache \
    curl \
    bash \
    python3 \
    make \
    g++ \
    openssl

WORKDIR /app

COPY package*.json ./

RUN npm install

COPY server ./server
COPY prisma ./prisma
COPY tsconfig.json ./

RUN npx prisma generate

EXPOSE 3001

ENV PORT=3001

CMD ["sh", "-c", "for i in 1 2 3 4 5 6 7 8 9 10; do npx prisma db push && break || sleep 5; done && npx tsx server/index.ts"]
